services:
  asa-server:
    container_name: asa-server
    hostname: asa-server
    image: "ghcr.io/jdogwilly/asa-linux-server:latest"
    tty: true
    environment:
      # RCON configuration (used by asa-ctrl for server management)
      - ADMIN_PASSWORD=testadmin123
      - RCON_PORT=27020

      # Server start parameters (simple literal values for testing)
      - ASA_START_PARAMS=TheIsland_WP?listen?Port=7777?RCONPort=27020?RCONEnabled=True?ServerAdminPassword=testadmin123 -WinLiveMaxPlayers=50 -clusterid=test-cluster -ClusterDirOverride="Z:\cluster"

      # Debug mode (0=disabled, 1=enabled - sleeps instead of starting server)
      - ENABLE_DEBUG=0

      # Crash watchdog (automatic restart on crash)
      # Enable auto-restart when server crashes (useful for game-side bugs)
      - ENABLE_CRASH_WATCHDOG=1              # Enable auto-restart (default: 0)
      - WATCHDOG_MAX_RESTARTS=10             # Max consecutive restarts (default: 10)
      - WATCHDOG_RESTART_DELAY=30            # Base delay between restarts in seconds (default: 30)
      - WATCHDOG_CHECK_INTERVAL=30           # Process check interval in seconds (default: 30)
    ulimits:
      # ARK requires 100,000+ open files for proper operation
      nofile:
        soft: 100000
        hard: 100000
    ports:
      # Game port for player connections through the server browser
      - 0.0.0.0:7777:7777/udp
      # RCON port for remote server administration
      - 0.0.0.0:27020:27020/tcp
    depends_on:
      - set-permissions
    volumes:
      - steam:/home/gameserver/Steam:rw
      - steamcmd:/home/gameserver/steamcmd:rw
      - server-files:/home/gameserver/server-files:rw
      - cluster-shared:/cluster:rw
      - /etc/localtime:/etc/localtime:ro
      # Optional: Mount config directory for INI files (GameUserSettings.ini, Game.ini, etc.)
      # Files are validated and copied to WindowsServer config directory on startup
      # Uncomment one of the following options:
      # - ./config:/config:ro              # Bind mount to local ./config directory
      # - asa-config:/config:ro            # Named volume (define below in volumes section)
    networks:
      asa-network:
  set-permissions:
    entrypoint: "/bin/bash -c 'chown -R 25000:25000 /steam ; chown -R 25000:25000 /steamcmd ; chown -R 25000:25000 /server-files ; chown -R 25000:25000 /cluster'"
    user: root
    image: "ubuntu:24.04"
    volumes:
      - steam:/steam:rw
      - steamcmd:/steamcmd:rw
      - server-files:/server-files:rw
      - cluster-shared:/cluster:rw
volumes:
  cluster-shared:
  steam:
  steamcmd:
  server-files:
networks:
  asa-network:
    attachable: true
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: 'asanet'
